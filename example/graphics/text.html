<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>text 文本示例（WebGL MSDF）</title>
</head>

<body>
  <div id="app">
    <div id="game-container">
      <canvas id="game-canvas" width="1200" height="800" style="border:1px solid #000;"></canvas>
    </div>
  </div>

  <script type="module">
    import { Engine, Components } from '../../src/main.ts';
    import { Font } from '../../src/utils/font.ts';

    const canvas = document.getElementById('game-canvas');
    const engine = new Engine(canvas);
    engine.boxDebug = true;

    function addText({ x, y, rotation = 0, scaleX = 1, scaleY = 1, skewX = 0, skewY = 0 }, textConfig, withEvent = false) {
      const e = engine.ecs.createEntity();
      const text = new Components.Text(engine, { ...textConfig, debug: true });
      const transform = new Components.Transform(engine, { x, y, rotation, scaleX, scaleY, skewX, skewY });

      engine.ecs.addComponent(e, text);
      engine.ecs.addComponent(e, transform);

      let event = null;
      if (withEvent) {
        event = new Components.EventComponent(engine);
        engine.ecs.addComponent(e, event);
      }

      engine.add(e);
      return { e, text, transform, event };
    }

    async function main() {
      // 注意：此页在 /example/graphics/，字体资源在 /font/output/
      // 这里使用相对路径指向仓库根目录下的 font/output/chinese-msdf.json
      const fontLoader = new Font();
      const { font, images } = await fontLoader.init('./output/chinese-msdf.json');
      const ifont = { font, images };

      // 1) 基本渲染：左上角
      addText(
        { x: 60, y: 120 },
        {
          font: ifont,
          text: 'Hello WebECS 文本渲染',
          size: 52,
          textAlign: 'left',
          textBaseline: 'alphabetic',
        },
        true
      ).event.on('click', (_ev, id) => {
        console.log('点击：Hello 文本', id);
      });

      // 2) 对齐演示：同一个锚点(600, 260)，分别 left/center/right
      const anchorX = 600;
      const baseY = 260;

      addText(
        { x: anchorX, y: baseY },
        {
          font: ifont,
          text: 'textAlign: left（锚点为左边）',
          size: 32,
          textAlign: 'left',
          textBaseline: 'alphabetic',
        }
      );

      addText(
        { x: anchorX, y: baseY + 70 },
        {
          font: ifont,
          text: 'textAlign: center（锚点为中间）',
          size: 32,
          textAlign: 'center',
          textBaseline: 'alphabetic',
        }
      );

      addText(
        { x: anchorX, y: baseY + 140 },
        {
          font: ifont,
          text: 'textAlign: right（锚点为右边）',
          size: 32,
          textAlign: 'right',
          textBaseline: 'alphabetic',
        }
      );

      // 3) 基线演示：同一个锚点(220, 560)，top/middle/alphabetic/bottom
      const anchorX2 = 220;
      const anchorY2 = 560;
      const baselineText = 'Baseline 对齐';

      addText(
        { x: anchorX2, y: anchorY2 },
        { font: ifont, text: `top：${baselineText}`, size: 36, textAlign: 'left', textBaseline: 'top' }
      );
      addText(
        { x: anchorX2, y: anchorY2 + 70 },
        { font: ifont, text: `middle：${baselineText}`, size: 36, textAlign: 'left', textBaseline: 'middle' }
      );
      addText(
        { x: anchorX2, y: anchorY2 + 140 },
        { font: ifont, text: `alphabetic：${baselineText}`, size: 36, textAlign: 'left', textBaseline: 'alphabetic' }
      );
      addText(
        { x: anchorX2, y: anchorY2 + 210 },
        { font: ifont, text: `bottom：${baselineText}`, size: 36, textAlign: 'left', textBaseline: 'bottom' }
      );

      // 4) Transform 动态：旋转 + 缩放
      {
        const { transform } = addText(
          { x: 860, y: 560 },
          {
            font: ifont,
            text: '动态 Transform：rotate + scale',
            size: 30,
            textAlign: 'center',
            textBaseline: 'middle',
          },
          true
        );

        engine.ticker.add(() => {
          const t = performance.now() * 0.001;
          transform.rotation = Math.sin(t) * 0.25;
          transform.scaleX = 1 + Math.sin(t * 1.3) * 0.08;
          transform.scaleY = 1 + Math.cos(t * 1.1) * 0.08;
        });
      }
      engine.start();
    }

    main();
  </script>
</body>

</html>
