(function(y,ut){typeof exports=="object"&&typeof module<"u"?ut(exports):typeof define=="function"&&define.amd?define(["exports"],ut):(y=typeof globalThis<"u"?globalThis:y||self,ut(y.webECS={}))})(this,(function(y){"use strict";class ut{nextId=0;entities=new Set;createEntity(){const t=this.nextId++;return this.entities.add(t),t}removeEntity(t){this.entities.delete(t)}hasEntity(t){return this.entities.has(t)}getAllEntities(){return Array.from(this.entities)}}class ve{componentsByType=new Map;addComponent(t,e){const r=e.constructor;let n=this.componentsByType.get(r);n||(n=new Map,this.componentsByType.set(r,n)),n.set(t,e)}removeComponent(t,e){this.componentsByType.get(e)?.delete(t)}getComponent(t,e){return this.componentsByType.get(e)?.get(t)}getEntitiesWithComponent(t){const e=this.componentsByType.get(t);return e?Array.from(e.keys()):[]}hasComponent(t,e){return this.componentsByType.get(e)?.has(t)??!1}}const $t=new Map;class ge{entities=[];componentTypes;columns=new Map;constructor(t){this.componentTypes=t;for(const e of t)this.columns.set(e,[])}add(t,e){this.entities.push(t);for(const r of this.componentTypes){const n=this.columns.get(r),o=e.get(r);if(!o)throw new Error(`Missing component ${r.name} for entity ${t}`);n.push(o)}}remove(t){const e=this.entities.indexOf(t);if(e!==-1){this.entities.splice(e,1);for(const r of this.columns.values())r.splice(e,1)}}matches(t){return t.every(e=>this.componentTypes.has(e))}getComponent(t,e){const r=this.entities.indexOf(t);if(r===-1)return;const n=this.columns.get(e);return n?n[r]:void 0}}class we{entityArchetypeMap=new Map;archetypeMap=new Map;getComponentKey(t){return Array.from(t).map(e=>e.name).sort().join("|")}getOrCreateArchetype(t){const e=this.getComponentKey(new Set(t.keys()));let r=this.archetypeMap.get(e);return r||(r=new ge(new Set(t.keys())),this.archetypeMap.set(e,r)),r}migrateEntity(t,e){const r=this.entityArchetypeMap.get(t);r&&r.remove(t);const n=this.getOrCreateArchetype(e);n.add(t,e),this.entityArchetypeMap.set(t,n)}getArchetypeOf(t){return this.entityArchetypeMap.get(t)}queryArchetypes(t){const e=this.getComponentKey(new Set(t)),r=this.archetypeMap.get(e);return r?[r]:[]}removeEntity(t){const e=this.entityArchetypeMap.get(t);e&&e.remove(t),this.entityArchetypeMap.delete(t)}}class st{#t;constructor(t,{}={}){this.#t=t,this.#t}}class Me{renderMap=new Map;map=new Map;componentEntityMap=new Map;getComponentsMap(t){return this.map.get(t)}isRenderComponent(t){return t instanceof st}addComponent(t,e){this.map.has(t)||this.map.set(t,new Map);const r=this.map.get(t),n=e.constructor;if(this.isRenderComponent(e)){const o=this.renderMap.get(t);if(o){const s=r.get(o);s&&this.componentEntityMap.delete(s),r.delete(o)}this.renderMap.set(t,n)}r.set(n,e),this.componentEntityMap.set(e,t)}removeEntity(t){const e=this.map.get(t);if(e)for(const r of e.values())this.componentEntityMap.delete(r);this.map.delete(t),this.renderMap.delete(t)}removeComponent(t,e){e===st&&this.renderMap.delete(t);const r=this.map.get(t);if(!r)return;const n=r.get(e);n&&this.componentEntityMap.delete(n),r.delete(e),r.size===0&&this.map.delete(t)}getComponent(t,e){return this.map.get(t)?.get(e)}getComponents(t){return this.map.get(t)}hasComponent(t,e){return this.map.get(t)?.has(e)??!1}getEntityIdByComponent(t){return this.componentEntityMap.get(t)}}class Ce{listeners={};on(t,e){this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e)}off(t,e){const r=this.listeners[t];r&&(e?r.delete(e):delete this.listeners[t])}emit(t,...e){const r=this.listeners[t];if(r)for(const n of r)n(...e)}clear(){for(const t in this.listeners)delete this.listeners[t]}}class xe{canvas;event=new Ce;entities=new ut;components=new ve;systems=[];ComponentRegistry=$t;entityComponents=new Me;archetypeManager=new we;#t=new Map;addSystem(t){t.init(this),this.systems.push(t),this.#t.set(t.constructor,t)}getSystem(t){return this.#t.get(t)}hasEntity(t){return this.entities.hasEntity(t)}createEntity(){const t=this.entities.createEntity();return this.event.emit("create_entity",t),t}removeEntity(t){if(!this.hasEntity(t))throw new Error(`Entity ${t} not exists`);this.entities.removeEntity(t),this.entityComponents.removeEntity(t),this.archetypeManager.removeEntity(t)}update(t){for(const e of this.systems)e.update(t)}addComponent(t,e){if(!this.hasEntity(t))throw new Error(`Entity ${t} not exists`);const r=Reflect.getMetadata("component:name",e.constructor);if(!this.ComponentRegistry.has(r))throw new Error(`Component "${r}" is not registered!`);this.entityComponents.addComponent(t,e);const n=this.entityComponents.getComponentsMap(t);this.archetypeManager.migrateEntity(t,n),this.event.emit("add_component",t,e)}removeComponent(t,e){if(!this.hasEntity(t))throw new Error(`Entity ${t} not exists`);this.entityComponents.removeComponent(t,e);const r=this.entityComponents.getComponentsMap(t);r&&r.size>0?this.archetypeManager.migrateEntity(t,r):this.archetypeManager.removeEntity(t),this.event.emit("remove_component",t,e)}getComponent(t,e){return this.entityComponents.getComponent(t,e)}getComponents(t){return this.entityComponents.getComponents(t)}hasComponent(t,e){return this.entityComponents.hasComponent(t,e)}getEntitiesWith(t){const e=this.archetypeManager.queryArchetypes(t),r=[];for(const n of e)r.push(...n.entities);return r}getEntityIdByComponent(t){return this.entityComponents.getEntityIdByComponent(t)}}class _e{lastTime=0;running=!1;callbacks=[];constructor(){this.loop=this.loop.bind(this)}add(t){this.callbacks.push(t)}remove(t){const e=this.callbacks.indexOf(t);e!==-1&&this.callbacks.splice(e,1)}start(){this.running||(this.running=!0,this.lastTime=performance.now(),setInterval(()=>{this.loop(performance.now())},20))}stop(){this.running=!1}loop(t){if(!this.running)return;const e=(t-this.lastTime)/1e3;this.lastTime=t;for(const r of this.callbacks)r(e)}}class It{constructor(t){this.entityId=t}parent=null;children=[];addChild(t){if(t.parent){const e=t.parent.children.indexOf(t);e!==-1&&t.parent.children.splice(e,1)}t.parent=this,this.children.push(t)}removeChild(t){const e=this.children.indexOf(t);if(e===-1)throw new Error(`Cannot remove child: entity ${t.entityId} is not a child of entity ${this.entityId}`);this.children.splice(e,1),t.parent=null}getDescendants(){const t=[];for(const e of this.children)t.push(e),t.push(...e.getDescendants());return t}}class Te{constructor(t){this.rootEntityId=t,this.root=new It(t),this.nodes.set(t,this.root)}nodes=new Map;root;add(t,e){this._version++,this.nodes.has(t)||this.nodes.set(t,new It(t)),e===void 0&&(e=this.rootEntityId);const r=this.nodes.get(t),n=this.nodes.get(e);r.parent=n,n.children.push(r),this.displayList=this.build()}remove(t){this._version++;const e=this.nodes.get(t);if(!e)throw new Error(`remove fail, Entity ${t} not found`);e.parent&&e.parent.removeChild(e),this.displayList=this.build()}get(t){return this.nodes.has(t)||this.nodes.set(t,new It(t)),this.nodes.get(t)}has(t){return this.nodes.has(t)}destory(t){this._version++;const e=this.nodes.get(t);if(!e)throw new Error(`destory fail, Entity ${t} not found`);const r=e.getDescendants();for(const n of r)this.nodes.delete(n.entityId);if(e.parent){const n=e.parent.children.indexOf(e);n!==-1&&e.parent.children.splice(n,1)}this.nodes.delete(t),this.displayList=this.build()}getParent(t){return this.nodes.get(t)?.parent||null}all(){return Array.from(this.nodes.values())}clear(){this._version++;for(const t of this.root.children.slice())this.destory(t.entityId);this.displayList=this.build()}caches=[];version=-1;_version=0;forEach(t,e,r=!1){if(this.version===this._version&&this.caches.length>0){this.forEachCaches(t,e,r);return}const n=[],o=new Map;o.set(this.root.entityId,e??{});const s=c=>{const a=c.parent?.entityId??null,h=a!=null?o.get(a):null;o.has(c.entityId)||o.set(c.entityId,{});const v=o.get(c.entityId);if(n.push({entityId:c.entityId,parentEntityId:a}),r){for(let u=c.children.length-1;u>=0;u--)s(c.children[u]);t(c.entityId,a,v,h)}else{t(c.entityId,a,v,h);for(let u=0;u<c.children.length;u++)s(c.children[u])}};s(this.root),this.caches=n,this.version=this._version}forEachCaches(t,e,r=!1){const n=new Map;n.set(this.root.entityId,e??{});const o=(s,c)=>{const a=n.get(s)??{};n.set(s,a);const h=c!=null?n.get(c):null;t(s,c,a,h||null)};if(r)for(let s=this.caches.length-1;s>=0;s--){const{entityId:c,parentEntityId:a}=this.caches[s];o(c,a)}else for(let s=0;s<this.caches.length;s++){const{entityId:c,parentEntityId:a}=this.caches[s];o(c,a)}}build(){const t=[];function e(r,n){if(t.push([r.entityId,n?.entityId??null]),r.children)for(const o of r.children)e(o,r)}return e(this.root,null),t}displayList=[]}var jt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Ft={};/*! *****************************************************************************
    Copyright (C) Microsoft. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var Gt;function Pe(){if(Gt)return Ft;Gt=1;var i;return(function(t){(function(e){var r=typeof globalThis=="object"?globalThis:typeof jt=="object"?jt:typeof self=="object"?self:typeof this=="object"?this:a(),n=o(t);typeof r.Reflect<"u"&&(n=o(r.Reflect,n)),e(n,r),typeof r.Reflect>"u"&&(r.Reflect=t);function o(h,v){return function(u,p){Object.defineProperty(h,u,{configurable:!0,writable:!0,value:p}),v&&v(u,p)}}function s(){try{return Function("return this;")()}catch{}}function c(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return s()||c()}})(function(e,r){var n=Object.prototype.hasOwnProperty,o=typeof Symbol=="function",s=o&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",c=o&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",h={__proto__:[]}instanceof Array,v=!a&&!h,u={create:a?function(){return Dt(Object.create(null))}:h?function(){return Dt({__proto__:null})}:function(){return Dt({})},has:v?function(l,f){return n.call(l,f)}:function(l,f){return f in l},get:v?function(l,f){return n.call(l,f)?l[f]:void 0}:function(l,f){return l[f]}},p=Object.getPrototypeOf(Function),g=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:Pn(),d=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:kn(),M=typeof WeakMap=="function"?WeakMap:bn(),w=o?Symbol.for("@reflect-metadata:registry"):void 0,k=xn(),S=_n(k);function I(l,f,m,C){if(A(m)){if(!he(l))throw new TypeError;if(!le(f))throw new TypeError;return N(l,f)}else{if(!he(l))throw new TypeError;if(!j(f))throw new TypeError;if(!j(C)&&!A(C)&&!ft(C))throw new TypeError;return ft(C)&&(C=void 0),m=tt(m),nt(l,f,m,C)}}e("decorate",I);function W(l,f){function m(C,b){if(!j(C))throw new TypeError;if(!A(b)&&!Mn(b))throw new TypeError;se(l,f,C,b)}return m}e("metadata",W);function G(l,f,m,C){if(!j(m))throw new TypeError;return A(C)||(C=tt(C)),se(l,f,m,C)}e("defineMetadata",G);function z(l,f,m){if(!j(f))throw new TypeError;return A(m)||(m=tt(m)),rt(l,f,m)}e("hasMetadata",z);function D(l,f,m){if(!j(f))throw new TypeError;return A(m)||(m=tt(m)),at(l,f,m)}e("hasOwnMetadata",D);function $(l,f,m){if(!j(f))throw new TypeError;return A(m)||(m=tt(m)),yt(l,f,m)}e("getMetadata",$);function q(l,f,m){if(!j(f))throw new TypeError;return A(m)||(m=tt(m)),re(l,f,m)}e("getOwnMetadata",q);function H(l,f){if(!j(l))throw new TypeError;return A(f)||(f=tt(f)),ie(l,f)}e("getMetadataKeys",H);function it(l,f){if(!j(l))throw new TypeError;return A(f)||(f=tt(f)),ae(l,f)}e("getOwnMetadataKeys",it);function U(l,f,m){if(!j(f))throw new TypeError;if(A(m)||(m=tt(m)),!j(f))throw new TypeError;A(m)||(m=tt(m));var C=vt(f,m,!1);return A(C)?!1:C.OrdinaryDeleteMetadata(l,f,m)}e("deleteMetadata",U);function N(l,f){for(var m=l.length-1;m>=0;--m){var C=l[m],b=C(f);if(!A(b)&&!ft(b)){if(!le(b))throw new TypeError;f=b}}return f}function nt(l,f,m,C){for(var b=l.length-1;b>=0;--b){var X=l[b],F=X(f,m,C);if(!A(F)&&!ft(F)){if(!j(F))throw new TypeError;C=F}}return C}function rt(l,f,m){var C=at(l,f,m);if(C)return!0;var b=Wt(f);return ft(b)?!1:rt(l,b,m)}function at(l,f,m){var C=vt(f,m,!1);return A(C)?!1:ce(C.OrdinaryHasOwnMetadata(l,f,m))}function yt(l,f,m){var C=at(l,f,m);if(C)return re(l,f,m);var b=Wt(f);if(!ft(b))return yt(l,b,m)}function re(l,f,m){var C=vt(f,m,!1);if(!A(C))return C.OrdinaryGetOwnMetadata(l,f,m)}function se(l,f,m,C){var b=vt(m,C,!0);b.OrdinaryDefineOwnMetadata(l,f,m,C)}function ie(l,f){var m=ae(l,f),C=Wt(l);if(C===null)return m;var b=ie(C,f);if(b.length<=0)return m;if(m.length<=0)return b;for(var X=new d,F=[],B=0,x=m;B<x.length;B++){var _=x[B],T=X.has(_);T||(X.add(_),F.push(_))}for(var P=0,E=b;P<E.length;P++){var _=E[P],T=X.has(_);T||(X.add(_),F.push(_))}return F}function ae(l,f){var m=vt(l,f,!1);return m?m.OrdinaryOwnMetadataKeys(l,f):[]}function oe(l){if(l===null)return 1;switch(typeof l){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return l===null?1:6;default:return 6}}function A(l){return l===void 0}function ft(l){return l===null}function yn(l){return typeof l=="symbol"}function j(l){return typeof l=="object"?l!==null:typeof l=="function"}function vn(l,f){switch(oe(l)){case 0:return l;case 1:return l;case 2:return l;case 3:return l;case 4:return l;case 5:return l}var m="string",C=fe(l,s);if(C!==void 0){var b=C.call(l,m);if(j(b))throw new TypeError;return b}return gn(l)}function gn(l,f){var m,C,b;{var X=l.toString;if(St(X)){var C=X.call(l);if(!j(C))return C}var m=l.valueOf;if(St(m)){var C=m.call(l);if(!j(C))return C}}throw new TypeError}function ce(l){return!!l}function wn(l){return""+l}function tt(l){var f=vn(l);return yn(f)?f:wn(f)}function he(l){return Array.isArray?Array.isArray(l):l instanceof Object?l instanceof Array:Object.prototype.toString.call(l)==="[object Array]"}function St(l){return typeof l=="function"}function le(l){return typeof l=="function"}function Mn(l){switch(oe(l)){case 3:return!0;case 4:return!0;default:return!1}}function Rt(l,f){return l===f||l!==l&&f!==f}function fe(l,f){var m=l[f];if(m!=null){if(!St(m))throw new TypeError;return m}}function ue(l){var f=fe(l,c);if(!St(f))throw new TypeError;var m=f.call(l);if(!j(m))throw new TypeError;return m}function de(l){return l.value}function pe(l){var f=l.next();return f.done?!1:f}function me(l){var f=l.return;f&&f.call(l)}function Wt(l){var f=Object.getPrototypeOf(l);if(typeof l!="function"||l===p||f!==p)return f;var m=l.prototype,C=m&&Object.getPrototypeOf(m);if(C==null||C===Object.prototype)return f;var b=C.constructor;return typeof b!="function"||b===l?f:b}function Cn(){var l;!A(w)&&typeof r.Reflect<"u"&&!(w in r.Reflect)&&typeof r.Reflect.defineMetadata=="function"&&(l=Tn(r.Reflect));var f,m,C,b=new M,X={registerProvider:F,getProvider:x,setProvider:T};return X;function F(P){if(!Object.isExtensible(X))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case l===P:break;case A(f):f=P;break;case f===P:break;case A(m):m=P;break;case m===P:break;default:C===void 0&&(C=new d),C.add(P);break}}function B(P,E){if(!A(f)){if(f.isProviderFor(P,E))return f;if(!A(m)){if(m.isProviderFor(P,E))return f;if(!A(C))for(var Y=ue(C);;){var R=pe(Y);if(!R)return;var V=de(R);if(V.isProviderFor(P,E))return me(Y),V}}}if(!A(l)&&l.isProviderFor(P,E))return l}function x(P,E){var Y=b.get(P),R;return A(Y)||(R=Y.get(E)),A(R)&&(R=B(P,E),A(R)||(A(Y)&&(Y=new g,b.set(P,Y)),Y.set(E,R))),R}function _(P){if(A(P))throw new TypeError;return f===P||m===P||!A(C)&&C.has(P)}function T(P,E,Y){if(!_(Y))throw new Error("Metadata provider not registered.");var R=x(P,E);if(R!==Y){if(!A(R))return!1;var V=b.get(P);A(V)&&(V=new g,b.set(P,V)),V.set(E,Y)}return!0}}function xn(){var l;return!A(w)&&j(r.Reflect)&&Object.isExtensible(r.Reflect)&&(l=r.Reflect[w]),A(l)&&(l=Cn()),!A(w)&&j(r.Reflect)&&Object.isExtensible(r.Reflect)&&Object.defineProperty(r.Reflect,w,{enumerable:!1,configurable:!1,writable:!1,value:l}),l}function _n(l){var f=new M,m={isProviderFor:function(_,T){var P=f.get(_);return A(P)?!1:P.has(T)},OrdinaryDefineOwnMetadata:F,OrdinaryHasOwnMetadata:b,OrdinaryGetOwnMetadata:X,OrdinaryOwnMetadataKeys:B,OrdinaryDeleteMetadata:x};return k.registerProvider(m),m;function C(_,T,P){var E=f.get(_),Y=!1;if(A(E)){if(!P)return;E=new g,f.set(_,E),Y=!0}var R=E.get(T);if(A(R)){if(!P)return;if(R=new g,E.set(T,R),!l.setProvider(_,T,m))throw E.delete(T),Y&&f.delete(_),new Error("Wrong provider for target.")}return R}function b(_,T,P){var E=C(T,P,!1);return A(E)?!1:ce(E.has(_))}function X(_,T,P){var E=C(T,P,!1);if(!A(E))return E.get(_)}function F(_,T,P,E){var Y=C(P,E,!0);Y.set(_,T)}function B(_,T){var P=[],E=C(_,T,!1);if(A(E))return P;for(var Y=E.keys(),R=ue(Y),V=0;;){var ye=pe(R);if(!ye)return P.length=V,P;var An=de(ye);try{P[V]=An}catch(Bn){try{me(R)}finally{throw Bn}}V++}}function x(_,T,P){var E=C(T,P,!1);if(A(E)||!E.delete(_))return!1;if(E.size===0){var Y=f.get(T);A(Y)||(Y.delete(P),Y.size===0&&f.delete(Y))}return!0}}function Tn(l){var f=l.defineMetadata,m=l.hasOwnMetadata,C=l.getOwnMetadata,b=l.getOwnMetadataKeys,X=l.deleteMetadata,F=new M,B={isProviderFor:function(x,_){var T=F.get(x);return!A(T)&&T.has(_)?!0:b(x,_).length?(A(T)&&(T=new d,F.set(x,T)),T.add(_),!0):!1},OrdinaryDefineOwnMetadata:f,OrdinaryHasOwnMetadata:m,OrdinaryGetOwnMetadata:C,OrdinaryOwnMetadataKeys:b,OrdinaryDeleteMetadata:X};return B}function vt(l,f,m){var C=k.getProvider(l,f);if(!A(C))return C;if(m){if(k.setProvider(l,f,S))return S;throw new Error("Illegal state.")}}function Pn(){var l={},f=[],m=(function(){function B(x,_,T){this._index=0,this._keys=x,this._values=_,this._selector=T}return B.prototype["@@iterator"]=function(){return this},B.prototype[c]=function(){return this},B.prototype.next=function(){var x=this._index;if(x>=0&&x<this._keys.length){var _=this._selector(this._keys[x],this._values[x]);return x+1>=this._keys.length?(this._index=-1,this._keys=f,this._values=f):this._index++,{value:_,done:!1}}return{value:void 0,done:!0}},B.prototype.throw=function(x){throw this._index>=0&&(this._index=-1,this._keys=f,this._values=f),x},B.prototype.return=function(x){return this._index>=0&&(this._index=-1,this._keys=f,this._values=f),{value:x,done:!0}},B})(),C=(function(){function B(){this._keys=[],this._values=[],this._cacheKey=l,this._cacheIndex=-2}return Object.defineProperty(B.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),B.prototype.has=function(x){return this._find(x,!1)>=0},B.prototype.get=function(x){var _=this._find(x,!1);return _>=0?this._values[_]:void 0},B.prototype.set=function(x,_){var T=this._find(x,!0);return this._values[T]=_,this},B.prototype.delete=function(x){var _=this._find(x,!1);if(_>=0){for(var T=this._keys.length,P=_+1;P<T;P++)this._keys[P-1]=this._keys[P],this._values[P-1]=this._values[P];return this._keys.length--,this._values.length--,Rt(x,this._cacheKey)&&(this._cacheKey=l,this._cacheIndex=-2),!0}return!1},B.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=l,this._cacheIndex=-2},B.prototype.keys=function(){return new m(this._keys,this._values,b)},B.prototype.values=function(){return new m(this._keys,this._values,X)},B.prototype.entries=function(){return new m(this._keys,this._values,F)},B.prototype["@@iterator"]=function(){return this.entries()},B.prototype[c]=function(){return this.entries()},B.prototype._find=function(x,_){if(!Rt(this._cacheKey,x)){this._cacheIndex=-1;for(var T=0;T<this._keys.length;T++)if(Rt(this._keys[T],x)){this._cacheIndex=T;break}}return this._cacheIndex<0&&_&&(this._cacheIndex=this._keys.length,this._keys.push(x),this._values.push(void 0)),this._cacheIndex},B})();return C;function b(B,x){return B}function X(B,x){return x}function F(B,x){return[B,x]}}function kn(){var l=(function(){function f(){this._map=new g}return Object.defineProperty(f.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),f.prototype.has=function(m){return this._map.has(m)},f.prototype.add=function(m){return this._map.set(m,m),this},f.prototype.delete=function(m){return this._map.delete(m)},f.prototype.clear=function(){this._map.clear()},f.prototype.keys=function(){return this._map.keys()},f.prototype.values=function(){return this._map.keys()},f.prototype.entries=function(){return this._map.entries()},f.prototype["@@iterator"]=function(){return this.keys()},f.prototype[c]=function(){return this.keys()},f})();return l}function bn(){var l=16,f=u.create(),m=C();return(function(){function x(){this._key=C()}return x.prototype.has=function(_){var T=b(_,!1);return T!==void 0?u.has(T,this._key):!1},x.prototype.get=function(_){var T=b(_,!1);return T!==void 0?u.get(T,this._key):void 0},x.prototype.set=function(_,T){var P=b(_,!0);return P[this._key]=T,this},x.prototype.delete=function(_){var T=b(_,!1);return T!==void 0?delete T[this._key]:!1},x.prototype.clear=function(){this._key=C()},x})();function C(){var x;do x="@@WeakMap@@"+B();while(u.has(f,x));return f[x]=!0,x}function b(x,_){if(!n.call(x,m)){if(!_)return;Object.defineProperty(x,m,{value:u.create()})}return x[m]}function X(x,_){for(var T=0;T<_;++T)x[T]=Math.random()*255|0;return x}function F(x){if(typeof Uint8Array=="function"){var _=new Uint8Array(x);return typeof crypto<"u"?crypto.getRandomValues(_):typeof msCrypto<"u"?msCrypto.getRandomValues(_):X(_,x),_}return X(new Array(x),x)}function B(){var x=F(l);x[6]=x[6]&79|64,x[8]=x[8]&191|128;for(var _="",T=0;T<l;++T){var P=x[T];(T===4||T===6||T===8)&&(_+="-"),P<16&&(_+="0"),_+=P.toString(16).toLowerCase()}return _}}function Dt(l){return l.__=void 0,delete l.__,l}})})(i||(i={})),Ft}Pe();function et(i){return function(t){Reflect.defineMetadata("component:name",i,t),$t.set(i,t)}}var ct=typeof Float32Array<"u"?Float32Array:Array;function Z(){var i=new ct(9);return ct!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function ke(i,t){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i}function be(i,t,e,r,n,o,s,c,a){var h=new ct(9);return h[0]=i,h[1]=t,h[2]=e,h[3]=r,h[4]=n,h[5]=o,h[6]=s,h[7]=c,h[8]=a,h}function Ae(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=0,i[7]=0,i[8]=1,i}function ot(i,t){var e=t[0],r=t[1],n=t[2],o=t[3],s=t[4],c=t[5],a=t[6],h=t[7],v=t[8],u=v*s-c*h,p=-v*o+c*a,g=h*o-s*a,d=e*u+r*p+n*g;return d?(d=1/d,i[0]=u*d,i[1]=(-v*r+n*h)*d,i[2]=(c*r-n*s)*d,i[3]=p*d,i[4]=(v*e-n*a)*d,i[5]=(-c*e+n*o)*d,i[6]=g*d,i[7]=(-h*e+r*a)*d,i[8]=(s*e-r*o)*d,i):null}function qt(i,t,e){var r=t[0],n=t[1],o=t[2],s=t[3],c=t[4],a=t[5],h=t[6],v=t[7],u=t[8],p=e[0],g=e[1],d=e[2],M=e[3],w=e[4],k=e[5],S=e[6],I=e[7],W=e[8];return i[0]=p*r+g*s+d*h,i[1]=p*n+g*c+d*v,i[2]=p*o+g*a+d*u,i[3]=M*r+w*s+k*h,i[4]=M*n+w*c+k*v,i[5]=M*o+w*a+k*u,i[6]=S*r+I*s+W*h,i[7]=S*n+I*c+W*v,i[8]=S*o+I*a+W*u,i}function zt(i,t,e){var r=t[0],n=t[1],o=t[2],s=t[3],c=t[4],a=t[5],h=t[6],v=t[7],u=t[8],p=e[0],g=e[1];return i[0]=r,i[1]=n,i[2]=o,i[3]=s,i[4]=c,i[5]=a,i[6]=p*r+g*s+h,i[7]=p*n+g*c+v,i[8]=p*o+g*a+u,i}function Be(i,t,e){var r=t[0],n=t[1],o=t[2],s=t[3],c=t[4],a=t[5],h=t[6],v=t[7],u=t[8],p=Math.sin(e),g=Math.cos(e);return i[0]=g*r+p*s,i[1]=g*n+p*c,i[2]=g*o+p*a,i[3]=g*s-p*r,i[4]=g*c-p*n,i[5]=g*a-p*o,i[6]=h,i[7]=v,i[8]=u,i}function Ee(i,t,e){var r=e[0],n=e[1];return i[0]=r*t[0],i[1]=r*t[1],i[2]=r*t[2],i[3]=n*t[3],i[4]=n*t[4],i[5]=n*t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i}function dt(){var i=new ct(2);return ct!=Float32Array&&(i[0]=0,i[1]=0),i}function O(i,t){var e=new ct(2);return e[0]=i,e[1]=t,e}function L(i,t,e){var r=t[0],n=t[1];return i[0]=e[0]*r+e[3]*n+e[6],i[1]=e[1]*r+e[4]*n+e[7],i}(function(){var i=dt();return function(t,e,r,n,o,s){var c,a;for(e||(e=2),r||(r=0),n?a=Math.min(n*e+r,t.length):a=t.length,c=r;c<a;c+=e)i[0]=t[c],i[1]=t[c+1],o(i,i,s),t[c]=i[0],t[c+1]=i[1];return t}})();var Se=Object.defineProperty,Ie=Object.getOwnPropertyDescriptor,Ht=i=>{throw TypeError(i)},Oe=(i,t,e)=>t in i?Se(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,Ye=(i,t,e,r)=>{for(var n=r>1?void 0:r?Ie(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n},Ot=(i,t,e)=>Oe(i,typeof t!="symbol"?t+"":t,e),Lt=(i,t,e)=>t.has(i)||Ht("Cannot "+e),J=(i,t,e)=>(Lt(i,t,"read from private field"),e?e.call(i):t.get(i)),Q=(i,t,e)=>t.has(i)?Ht("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e),K=(i,t,e,r)=>(Lt(i,t,"write to private field"),t.set(i,e),e),gt,wt,Mt,Ct,xt,_t,Tt,Pt,kt,bt;y.Transform=class{constructor(t,e={}){Q(this,gt,0),Q(this,wt,0),Q(this,Mt,1),Q(this,Ct,1),Q(this,xt,0),Q(this,_t,0),Q(this,Tt,0),Q(this,Pt,0),Q(this,kt,0),Ot(this,"localMatrix",Z()),Ot(this,"worldMatrix",Z()),Ot(this,"dirty",!0),Q(this,bt),K(this,bt,t),J(this,bt);const r=["x","y","scaleX","scaleY","rotation","skewX","skewY","pivotX","pivotY"];for(const n of r)e[n]!==void 0&&(this[n]=e[n])}get x(){return J(this,gt)}set x(t){K(this,gt,t),this.dirty=!0}get y(){return J(this,wt)}set y(t){K(this,wt,t),this.dirty=!0}get scaleX(){return J(this,Mt)}set scaleX(t){K(this,Mt,t),this.dirty=!0}get scaleY(){return J(this,Ct)}set scaleY(t){K(this,Ct,t),this.dirty=!0}get rotation(){return J(this,xt)}set rotation(t){K(this,xt,t),this.dirty=!0}get skewX(){return J(this,_t)}set skewX(t){K(this,_t,t),this.dirty=!0}get skewY(){return J(this,Tt)}set skewY(t){K(this,Tt,t),this.dirty=!0}get pivotX(){return J(this,Pt)}set pivotX(t){K(this,Pt,t),this.dirty=!0}get pivotY(){return J(this,kt)}set pivotY(t){K(this,kt,t),this.dirty=!0}},gt=new WeakMap,wt=new WeakMap,Mt=new WeakMap,Ct=new WeakMap,xt=new WeakMap,_t=new WeakMap,Tt=new WeakMap,Pt=new WeakMap,kt=new WeakMap,bt=new WeakMap,y.Transform=Ye([et("Transform")],y.Transform);class Xe{constructor(t){this.engine=t,this.entityId=this.engine.ecs.createEntity(),this.engine.ecs.addComponent(this.entityId,new y.Transform(this.engine,{x:0,y:0}))}entityId;get transform(){return this.engine.ecs.getComponent(this.entityId,y.Transform)}}class At{constructor(t,e){this.engine=t,this.sceneTree=e}ecs;init(t){this.ecs=t,this.onInit()}onInit(){}}var Re=Object.getOwnPropertyDescriptor,We=(i,t,e,r)=>{for(var n=r>1?void 0:r?Re(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.Rect=class extends st{width;height;render=!0;fillStyle;strokeStyle;lineWidth;alpha;radius;constructor(t,{width:e=0,height:r=0,fillStyle:n="#181b1dff",strokeStyle:o,lineWidth:s=0,alpha:c=1,render:a=!0,radius:h=0}={}){super(t),this.width=e,this.height=r,this.fillStyle=n||"#181b1dff",this.strokeStyle=o||"#181b1dff",this.lineWidth=s||0,this.alpha=c||1,this.radius=h||0,this.render=a}},y.Rect=We([et("Rect")],y.Rect);class De{match(t,e){return t.hasComponent(e,y.Rect)}exec(t,e){const r=t.ecs,n=r.canvas.getContext("2d"),o=r.getComponent(e,y.Transform),s=r.getComponent(e,y.Rect);if(!s.render)return;n.save(),n.globalAlpha=s.alpha;const c=o.worldMatrix;n.setTransform(c[0],c[1],c[3],c[4],c[6],c[7]);const{width:a,height:h,radius:v=0}=s;n.beginPath(),v>0?n.roundRect(0,0,a,h,v):n.rect(0,0,a,h),s.fillStyle&&(n.fillStyle=s.fillStyle,n.fill()),s.strokeStyle&&s.lineWidth>0&&(n.strokeStyle=s.strokeStyle,n.lineWidth=s.lineWidth,n.stroke()),n.restore()}}var $e=Object.getOwnPropertyDescriptor,je=(i,t,e,r)=>{for(var n=r>1?void 0:r?$e(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.Circle=class extends st{render=!0;radius;radiusY;fillStyle;strokeStyle;lineWidth;alpha;rotation;startAngle;endAngle;clockwise;constructor(t,{radius:e=10,radiusY:r,fillStyle:n="#e74c3c",strokeStyle:o,lineWidth:s=0,alpha:c=1,rotation:a=0,render:h=!0,startAngle:v=0,endAngle:u=Math.PI*2,clockwise:p=!0}={}){super(t),this.radius=e,r&&(this.radiusY=r),this.fillStyle=n,this.strokeStyle=o??"#c0392b",this.lineWidth=s,this.alpha=c,this.rotation=a,this.render=h,this.startAngle=v,this.endAngle=u,this.clockwise=p}get isCircle(){return this.radius===this.radiusY}get isFullCircle(){return Math.abs(this.endAngle-this.startAngle)>=Math.PI*2&&this.isCircle}},y.Circle=je([et("Circle")],y.Circle);class Fe{match(t,e){return t.hasComponent(e,y.Circle)}exec(t,e){const r=t.ecs,n=r.canvas.getContext("2d"),o=r.getComponent(e,y.Transform),s=r.getComponent(e,y.Circle);if(!s.render)return;n.save(),n.globalAlpha=s.alpha;const c=o.worldMatrix;n.setTransform(c[0],c[1],c[3],c[4],c[6],c[7]);const{radius:a,radiusY:h=a,rotation:v=0,startAngle:u=0,endAngle:p=Math.PI*2,clockwise:g=!1}=s;n.beginPath(),h===a?n.arc(0,0,a,u,p,!!g):n.ellipse(0,0,a,h,v,u,p,!!g),s.fillStyle&&(n.fillStyle=s.fillStyle,n.fill()),s.strokeStyle&&s.lineWidth>0&&(n.strokeStyle=s.strokeStyle,n.lineWidth=s.lineWidth,n.stroke()),n.restore()}}var Ge=Object.defineProperty,qe=Object.getOwnPropertyDescriptor,Nt=i=>{throw TypeError(i)},ze=(i,t,e)=>t in i?Ge(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,He=(i,t,e,r)=>{for(var n=r>1?void 0:r?qe(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n},Yt=(i,t,e)=>ze(i,typeof t!="symbol"?t+"":t,e),Ut=(i,t,e)=>t.has(i)||Nt("Cannot "+e),pt=(i,t,e)=>(Ut(i,t,"read from private field"),e?e.call(i):t.get(i)),Xt=(i,t,e)=>t.has(i)?Nt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e),mt=(i,t,e,r)=>(Ut(i,t,"write to private field"),t.set(i,e),e),Bt,ht,lt;y.Image=class extends st{constructor(t,e={}){super(t),Xt(this,Bt,null),Xt(this,ht,0),Xt(this,lt,0),Yt(this,"alpha",1),Yt(this,"render",!0),Yt(this,"clip"),e.clip!==void 0&&(this.clip=e.clip),e.bitmap!==void 0&&(this.bitmap=e.bitmap),e.width!==void 0&&(this.width=e.width),e.height!==void 0&&(this.height=e.height),e.alpha!==void 0&&(this.alpha=e.alpha),e.render!==void 0&&(this.render=e.render)}get bitmap(){return pt(this,Bt)}set bitmap(t){mt(this,Bt,t),t&&pt(this,ht)===0&&mt(this,ht,t.width),t&&pt(this,lt)===0&&mt(this,lt,t.height)}get width(){return pt(this,ht)}set width(t){mt(this,ht,t)}get height(){return pt(this,lt)}set height(t){mt(this,lt,t)}},Bt=new WeakMap,ht=new WeakMap,lt=new WeakMap,y.Image=He([et("Image")],y.Image);class Le{match(t,e){return t.hasComponent(e,y.Image)}exec(t,e){const r=t.ecs,n=r.canvas.getContext("2d"),o=r.getComponent(e,y.Transform),s=r.getComponent(e,y.Image);if(!s.render||!s.bitmap)return;n.save(),n.globalAlpha=s.alpha;const[c,a,h,v]=s.clip||[0,0,s.bitmap.width,s.bitmap.height],u=o.worldMatrix;n.setTransform(u[0],u[1],u[3],u[4],u[6],u[7]),n.drawImage(s.bitmap,c,a,h,v,0,0,s.width,s.height),n.restore()}}var Ne=Object.getOwnPropertyDescriptor,Ue=(i,t,e,r)=>{for(var n=r>1?void 0:r?Ne(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.BoundingBoxComponent=class{selfAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};childrenAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};totalAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};dirty=!0;constructor(){}reset(){this.selfAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},this.childrenAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},this.totalAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}setSelf(t){this.selfAABB.minX=t.minX,this.selfAABB.minY=t.minY,this.selfAABB.maxX=t.maxX,this.selfAABB.maxY=t.maxY,this.dirty=!0}setChildren(t){this.childrenAABB.minX=t.minX,this.childrenAABB.minY=t.minY,this.childrenAABB.maxX=t.maxX,this.childrenAABB.maxY=t.maxY,this.dirty=!0}updateTotalAABB(){this.totalAABB={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},this.merge(this.totalAABB,this.selfAABB),this.merge(this.totalAABB,this.childrenAABB),this.dirty=!1}hitTest(t,e,r="total"){let n;switch(r){case"self":n=this.selfAABB;break;case"children":n=this.childrenAABB;break;case"total":n=this.totalAABB;break}return t>=n.minX&&e>=n.minY&&t<=n.maxX&&e<=n.maxY}merge(t,e){t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY)}},y.BoundingBoxComponent=Ue([et("BoundingBoxComponent")],y.BoundingBoxComponent);const Ve=Z();class Vt{match(t,e){return!0}exec(t,e,r,n,o){const c=t.ecs.getComponent(e,y.Transform);if(n.dirty=c.dirty,!(n.dirty||(o?o.dirty:!1)))return;n.dirty=!0,c.dirty=!1;const h=t.ecs.getComponent(e,y.BoundingBoxComponent);h&&(h.dirty=!0),this.updateEntityMatrix(t,e)}updateEntityMatrix(t,e){const r=t.ecs,n=r.getComponent(e,y.Transform);Ae(n.localMatrix);const o=n.pivotX,s=n.pivotY;if(zt(n.localMatrix,n.localMatrix,[n.x+o,n.y+s]),Be(n.localMatrix,n.localMatrix,n.rotation),n.skewX!==0||n.skewY!==0){const a=be(1,Math.tan(n.skewX),0,Math.tan(n.skewY),1,0,0,0,1);qt(n.localMatrix,n.localMatrix,a)}Ee(n.localMatrix,n.localMatrix,[n.scaleX,n.scaleY]),zt(n.localMatrix,n.localMatrix,[-o,-s]);const c=t.sceneTree.getParent(e);if(c!=null){const h=r.getComponent(c.entityId,y.Transform)?.worldMatrix||Ve;qt(n.worldMatrix,h,n.localMatrix)}else ke(n.worldMatrix,n.localMatrix)}}class Zt{match(t,e){return t.hasComponent(e,y.Circle)}computeAABB(t,e){const r=t.getComponent(e,y.Circle),n=t.getComponent(e,y.Transform),{radius:o,radiusY:s=o,rotation:c=0,startAngle:a,endAngle:h,clockwise:v}=r,u=n.worldMatrix,p=u[6],g=u[7],d=u[0],M=u[1],w=u[3],k=u[4],S=o*Math.hypot(d,M),I=s*Math.hypot(w,k);if(a===0&&h===2*Math.PI){const G=Math.cos(c),z=Math.sin(c),D=Math.abs(S*G)+Math.abs(I*z),$=Math.abs(S*z)+Math.abs(I*G);return{minX:p-D,minY:g-$,maxX:p+D,maxY:g+$}}else{const G=[a,h],z=[0,Math.PI/2,Math.PI,3*Math.PI/2];for(const N of z)this.isAngleBetween(N,a,h,v)&&G.push(N);let D=1/0,$=1/0,q=-1/0,H=-1/0;const it=Math.cos(c),U=Math.sin(c);for(const N of G){const nt=S*Math.cos(N),rt=I*Math.sin(N),at=nt*it-rt*U,yt=nt*U+rt*it;D=Math.min(D,at),$=Math.min($,yt),q=Math.max(q,at),H=Math.max(H,yt)}return D=Math.min(D,0),$=Math.min($,0),q=Math.max(q,0),H=Math.max(H,0),{minX:p+D,minY:g+$,maxX:p+q,maxY:g+H}}}hit(t,e,r,n){const o=t.getComponent(e,y.Circle);return o.startAngle===0&&o.endAngle===2*Math.PI?this.hitFullCircle(t,e,r,n):this.hitArc(t,e,r,n)}hitFullCircle(t,e,r,n){const o=t.getComponent(e,y.Circle),s=t.getComponent(e,y.Transform),{radius:c,radiusY:a=c,rotation:h=0}=o,v=s.worldMatrix,u=Z();ot(u,v);const p=O(r,n);L(p,p,u);let g=p[0],d=p[1];if(h!==0){const w=Math.cos(-h),k=Math.sin(-h),S=g*w-d*k,I=g*k+d*w;g=S,d=I}return g*g/(c*c)+d*d/(a*a)<=1}hitArc(t,e,r,n){const o=t.getComponent(e,y.Circle),s=t.getComponent(e,y.Transform),{radius:c,radiusY:a=c,rotation:h=0,startAngle:v,endAngle:u,clockwise:p}=o,g=s.worldMatrix,d=Z();ot(d,g);const M=O(r,n);L(M,M,d);let w=M[0],k=M[1];if(h!==0){const U=Math.cos(-h),N=Math.sin(-h),nt=w*U-k*N,rt=w*N+k*U;w=nt,k=rt}const S=w/c,I=k/a,W=Math.hypot(S,I);let G=Math.atan2(I,S);G<0&&(G+=2*Math.PI);const z=this.isAngleBetween(G,v,u,p);if(W<=1&&z)return!0;const D=c*Math.cos(v),$=a*Math.sin(v),q=c*Math.cos(u),H=a*Math.sin(u),it=p?[{x:0,y:0},{x:D,y:$},{x:q,y:H}]:[{x:0,y:0},{x:q,y:H},{x:D,y:$}];return!!this.pointInPolygon({x:w,y:k},it)}isAngleBetween(t,e,r,n){return t=(t+2*Math.PI)%(2*Math.PI),e=(e+2*Math.PI)%(2*Math.PI),r=(r+2*Math.PI)%(2*Math.PI),n?(e-t+2*Math.PI)%(2*Math.PI)<=(e-r+2*Math.PI)%(2*Math.PI):(t-e+2*Math.PI)%(2*Math.PI)<=(r-e+2*Math.PI)%(2*Math.PI)}pointInPolygon(t,e){let r=!1;const n=e.length;for(let o=0,s=n-1;o<n;s=o++){const c=e[o].x,a=e[o].y,h=e[s].x,v=e[s].y;a>t.y!=v>t.y&&t.x<(h-c)*(t.y-a)/(v-a+1e-10)+c&&(r=!r)}return r}}class Jt{match(t,e){return t.hasComponent(e,y.Rect)}computeAABB(t,e){const r=t.getComponent(e,y.Rect),n=t.getComponent(e,y.Transform),{width:o,height:s}=r,{pivotX:c,pivotY:a}=n,h=n.worldMatrix,u=[O(-c,-a),O(o-c,-a),O(o-c,s-a),O(-c,s-a)].map(w=>L(dt(),w,h));let p=1/0,g=1/0,d=-1/0,M=-1/0;for(const w of u)p=Math.min(p,w[0]),g=Math.min(g,w[1]),d=Math.max(d,w[0]),M=Math.max(M,w[1]);return{minX:p,minY:g,maxX:d,maxY:M}}hit(t,e,r,n){const o=t.getComponent(e,y.Rect),s=t.getComponent(e,y.Transform),{width:c,height:a,radius:h=0}=o,{pivotX:v,pivotY:u}=s,p=s.worldMatrix,g=Z();ot(g,p);const d=O(r,n);L(d,d,g);const M=d[0],w=d[1];if(M<-v||M>c-v||w<-u||w>a-u)return!1;if(h<=0)return!0;const k=[[-v+h,-u+h],[c-v-h,-u+h],[c-v-h,a-u-h],[-v+h,a-u-h]],S=[M<-v+h&&w<-u+h,M>c-v-h&&w<-u+h,M>c-v-h&&w>a-u-h,M<-v+h&&w>a-u-h];for(let I=0;I<4;I++)if(S[I]){const W=M-k[I][0],G=w-k[I][1];if(W*W+G*G>h*h)return!1}return!0}}class Qt{match(t,e){return t.hasComponent(e,y.Image)}computeAABB(t,e){const r=t.getComponent(e,y.Image),n=t.getComponent(e,y.Transform),{width:o,height:s}=r,c=n.worldMatrix,h=[O(0,0),O(o,0),O(0,s),O(o,s)].map(d=>{const M=dt();return L(M,d,c),M});let v=1/0,u=1/0,p=-1/0,g=-1/0;for(const d of h)d[0]<v&&(v=d[0]),d[1]<u&&(u=d[1]),d[0]>p&&(p=d[0]),d[1]>g&&(g=d[1]);return{minX:v,minY:u,maxX:p,maxY:g}}hit(t,e,r,n){const o=t.getComponent(e,y.Image),s=t.getComponent(e,y.Transform),{width:c,height:a}=o,h=s.worldMatrix,v=Z();ot(v,h);const u=O(r,n);L(u,u,v);const p=u[0],g=u[1];return p>=0&&p<=c&&g>=0&&g<=a}}var Ze=Object.getOwnPropertyDescriptor,Je=(i,t,e,r)=>{for(var n=r>1?void 0:r?Ze(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.Polyline=class extends st{points=[];closed=!1;fillStyle;strokeStyle;lineWidth;alpha;render=!0;constructor(t,{points:e=[],closed:r=!1,fillStyle:n,strokeStyle:o="#000000",lineWidth:s=1,alpha:c=1,render:a=!0}={}){super(t),this.points=e,this.closed=r,this.fillStyle=n,this.strokeStyle=o,this.lineWidth=s,this.alpha=c,this.render=a}},y.Polyline=Je([et("Polyline")],y.Polyline);class Kt{match(t,e){return t.hasComponent(e,y.Polyline)}computeAABB(t,e){const r=t.getComponent(e,y.Polyline),o=t.getComponent(e,y.Transform).worldMatrix;if(!r.points||r.points.length===0)return{minX:0,minY:0,maxX:0,maxY:0};const s=r.points.map(u=>L(dt(),O(u[0],u[1]),o));let c=1/0,a=1/0,h=-1/0,v=-1/0;for(const u of s)c=Math.min(c,u[0]),a=Math.min(a,u[1]),h=Math.max(h,u[0]),v=Math.max(v,u[1]);return{minX:c,minY:a,maxX:h,maxY:v}}hit(t,e,r,n){const o=t.getComponent(e,y.Polyline),s=t.getComponent(e,y.Transform);if(!o.points||o.points.length<2)return!1;const c=Z();ot(c,s.worldMatrix);const a=O(r,n);L(a,a,c);const h=o.points,v=a[0],u=a[1];if(o.closed){let p=!1;for(let g=0,d=h.length-1;g<h.length;d=g++){const M=h[g][0],w=h[g][1],k=h[d][0],S=h[d][1];w>u!=S>u&&v<(k-M)*(u-w)/(S-w)+M&&(p=!p)}return p}else{for(let g=0;g<h.length-1;g++){const d=h[g],M=h[g+1];if(this.pointToSegmentDistance(v,u,d[0],d[1],M[0],M[1])<=3)return!0}return!1}}pointToSegmentDistance(t,e,r,n,o,s){const c=o-r,a=s-n;if(c===0&&a===0)return Math.hypot(t-r,e-n);const h=((t-r)*c+(e-n)*a)/(c*c+a*a),v=Math.max(0,Math.min(1,h)),u=r+v*c,p=n+v*a;return Math.hypot(t-u,e-p)}}var Qe=Object.getOwnPropertyDescriptor,Ke=(i,t,e,r)=>{for(var n=r>1?void 0:r?Qe(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.Curve=class extends st{start=[0,0];cp1=[0,0];cp2;end=[0,0];strokeStyle="#000";lineWidth=1;alpha=1;render=!0;constructor(t,e={}){super(t),this.start=e.start||this.start,this.cp1=e.cp1||this.cp1,this.cp2=e.cp2||this.cp2,this.end=e.end||this.end,this.strokeStyle=e.strokeStyle||this.strokeStyle,this.lineWidth=e.lineWidth||this.lineWidth,this.alpha=e.alpha||this.alpha,this.render=e.render||this.render}},y.Curve=Ke([et("Curve")],y.Curve);class te{match(t,e){return t.hasComponent(e,y.Curve)}computeAABB(t,e){const r=t.getComponent(e,y.Curve),o=t.getComponent(e,y.Transform).worldMatrix,s=[],c=30;for(let p=0;p<=1;p+=1/c){let g,d;if(r.cp2){const w=1-p;g=w**3*r.start[0]+3*w**2*p*r.cp1[0]+3*w*p**2*r.cp2[0]+p**3*r.end[0],d=w**3*r.start[1]+3*w**2*p*r.cp1[1]+3*w*p**2*r.cp2[1]+p**3*r.end[1]}else{const w=1-p;g=w**2*r.start[0]+2*w*p*r.cp1[0]+p**2*r.end[0],d=w**2*r.start[1]+2*w*p*r.cp1[1]+p**2*r.end[1]}const M=O(g,d);L(M,M,o),s.push(M)}let a=1/0,h=1/0,v=-1/0,u=-1/0;for(const p of s)a=Math.min(a,p[0]),h=Math.min(h,p[1]),v=Math.max(v,p[0]),u=Math.max(u,p[1]);return{minX:a,minY:h,maxX:v,maxY:u}}hit(t,e,r,n){const o=t.getComponent(e,y.Curve),c=t.getComponent(e,y.Transform).worldMatrix,a=Z();ot(a,c);const h=O(r,n);L(h,h,a);const v=50;let u=1/0;for(let p=0;p<=1;p+=1/v){let g,d;if(o.cp2){const k=1-p;g=k**3*o.start[0]+3*k**2*p*o.cp1[0]+3*k*p**2*o.cp2[0]+p**3*o.end[0],d=k**3*o.start[1]+3*k**2*p*o.cp1[1]+3*k*p**2*o.cp2[1]+p**3*o.end[1]}else{const k=1-p;g=k**2*o.start[0]+2*k*p*o.cp1[0]+p**2*o.end[0],d=k**2*o.start[1]+2*k*p*o.cp1[1]+p**2*o.end[1]}const M=h[0]-g,w=h[1]-d;u=Math.min(u,Math.sqrt(M*M+w*w))}return u<=(o.lineWidth||5)}}var tn=Object.getOwnPropertyDescriptor,en=(i,t,e,r)=>{for(var n=r>1?void 0:r?tn(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.Path=class extends st{commands=[];strokeStyle;fillStyle;lineWidth=1;alpha=1;render=!0;path2D;constructor(t,e={}){super(t),this.commands=e.commands||[],this.strokeStyle=e.strokeStyle||"#000000",this.fillStyle=e.fillStyle||void 0,this.lineWidth=e.lineWidth??1,this.alpha=e.alpha??1,this.render=e.render??!0,this.updatePath2D()}addCommand(t){this.commands.push(t),this.updatePath2D()}clear(){this.commands.length=0,this.updatePath2D()}updatePath2D(){const t=new Path2D;for(const e of this.commands)switch(e.type){case"moveTo":t.moveTo(e.x,e.y);break;case"lineTo":t.lineTo(e.x,e.y);break;case"quadraticCurveTo":t.quadraticCurveTo(e.cp[0],e.cp[1],e.end[0],e.end[1]);break;case"bezierCurveTo":t.bezierCurveTo(e.cp1[0],e.cp1[1],e.cp2[0],e.cp2[1],e.end[0],e.end[1]);break;case"arc":t.arc(e.center[0],e.center[1],e.radius,e.start,e.end,e.counterClockwise);break;case"arcTo":t.arcTo(e.cp1[0],e.cp1[1],e.cp2[0],e.cp2[1],e.radius);break;case"ellipse":t.ellipse(e.center[0],e.center[1],e.radiusX,e.radiusY,e.rotation??0,e.start??0,e.end??2*Math.PI,e.counterClockwise??!1);break;case"close":t.closePath();break}this.path2D=t}},y.Path=en([et("Path")],y.Path);class Et{offscreenCanvas;offscreenCtx;constructor(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=1,this.offscreenCanvas.height=1;const t=this.offscreenCanvas.getContext("2d");if(!t)throw new Error("Offscreen canvas context not available");this.offscreenCtx=t}match(t,e){return t.hasComponent(e,y.Path)}computeAABB(t,e){const r=t.getComponent(e,y.Path),o=t.getComponent(e,y.Transform).worldMatrix,s=[];let c=[0,0];const a=20;for(const d of r.commands)switch(d.type){case"moveTo":c=[d.x,d.y],s.push(O(...c));break;case"lineTo":c=[d.x,d.y],s.push(O(...c));break;case"quadraticCurveTo":for(let M=0;M<=1;M+=1/a){const w=1-M,k=w**2*c[0]+2*w*M*d.cp[0]+M**2*d.end[0],S=w**2*c[1]+2*w*M*d.cp[1]+M**2*d.end[1];s.push(O(k,S))}c=[...d.end];break;case"bezierCurveTo":for(let M=0;M<=1;M+=1/a){const w=1-M,k=w**3*c[0]+3*w**2*M*d.cp1[0]+3*w*M**2*d.cp2[0]+M**3*d.end[0],S=w**3*c[1]+3*w**2*M*d.cp1[1]+3*w*M**2*d.cp2[1]+M**3*d.end[1];s.push(O(k,S))}c=[...d.end];break;case"arc":{const[M,w]=d.center;for(let k=0;k<=1;k+=1/a){const S=d.start+k*(d.end-d.start),I=M+d.radius*Math.cos(S),W=w+d.radius*Math.sin(S);s.push(O(I,W))}c=[M+d.radius*Math.cos(d.end),w+d.radius*Math.sin(d.end)];break}case"arcTo":s.push(O(d.cp1[0],d.cp1[1])),s.push(O(d.cp2[0],d.cp2[1])),c=[...d.cp2];break;case"ellipse":{const[M,w]=d.center,k=d.radiusX,S=d.radiusY,I=d.rotation??0;for(let W=0;W<=1;W+=1/a){const G=W*2*Math.PI,z=Math.cos(G),D=Math.sin(G),$=M+k*z*Math.cos(I)-S*D*Math.sin(I),q=w+k*z*Math.sin(I)+S*D*Math.cos(I);s.push(O($,q))}c=[M+k*Math.cos(0),w+S*Math.sin(0)];break}}const h=s.map(d=>L(dt(),d,o));let v=1/0,u=1/0,p=-1/0,g=-1/0;for(const d of h)v=Math.min(v,d[0]),u=Math.min(u,d[1]),p=Math.max(p,d[0]),g=Math.max(g,d[1]);return{minX:v,minY:u,maxX:p,maxY:g}}hit(t,e,r,n){const o=t.getComponent(e,y.Path),c=t.getComponent(e,y.Transform).worldMatrix,a=Z();ot(a,c);const h=O(r,n);L(h,h,a);const v=o.commands.some(u=>u.type==="close");if(o.path2D){const u=this.offscreenCtx;u.save(),u.clearRect(0,0,1,1),u.lineWidth=o.lineWidth??1;const p=v?u.isPointInPath(o.path2D,h[0],h[1]):u.isPointInStroke(o.path2D,h[0],h[1]);return u.restore(),p}else return v?this.isPointInPath(o,h[0],h[1]):Et.isPointNearPath(o,h[0],h[1])}isPointInPath(t,e,r){const n=this.offscreenCtx;n.save(),n.clearRect(0,0,1,1),n.beginPath();for(const s of t.commands)switch(s.type){case"moveTo":n.moveTo(s.x,s.y);break;case"lineTo":n.lineTo(s.x,s.y);break;case"quadraticCurveTo":n.quadraticCurveTo(s.cp[0],s.cp[1],s.end[0],s.end[1]);break;case"bezierCurveTo":n.bezierCurveTo(s.cp1[0],s.cp1[1],s.cp2[0],s.cp2[1],s.end[0],s.end[1]);break;case"arc":n.arc(s.center[0],s.center[1],s.radius,s.start,s.end,s.counterClockwise);break;case"arcTo":n.arcTo(s.cp1[0],s.cp1[1],s.cp2[0],s.cp2[1],s.radius);break;case"ellipse":n.ellipse(s.center[0],s.center[1],s.radiusX,s.radiusY,s.rotation??0,0,2*Math.PI);break;case"close":n.closePath();break}const o=n.isPointInPath(e,r);return n.restore(),o}static isPointNearPath(t,e,r){const o=t.lineWidth??5;let s=[0,0],c=1/0;for(const a of t.commands)switch(a.type){case"moveTo":s=[a.x,a.y];break;case"lineTo":{const h=a.x-s[0],v=a.y-s[1];if(h!==0||v!==0){const u=((e-s[0])*h+(r-s[1])*v)/(h*h+v*v),p=Math.max(0,Math.min(1,u)),g=s[0]+h*p,d=s[1]+v*p;c=Math.min(c,Math.hypot(e-g,r-d))}s=[a.x,a.y];break}case"quadraticCurveTo":for(let h=0;h<=1;h+=1/50){const v=1-h,u=v**2*s[0]+2*v*h*a.cp[0]+h**2*a.end[0],p=v**2*s[1]+2*v*h*a.cp[1]+h**2*a.end[1];c=Math.min(c,Math.hypot(e-u,r-p))}s=[...a.end];break;case"bezierCurveTo":for(let h=0;h<=1;h+=1/50){const v=1-h,u=v**3*s[0]+3*v**2*h*a.cp1[0]+3*v*h**2*a.cp2[0]+h**3*a.end[0],p=v**3*s[1]+3*v**2*h*a.cp1[1]+3*v*h**2*a.cp2[1]+h**3*a.end[1];c=Math.min(c,Math.hypot(e-u,r-p))}s=[...a.end];break;case"arc":{const[h,v]=a.center,u=a.start,p=a.end,g=(p-u)/50;for(let d=0;d<=50;d++){const M=u+g*d,w=h+a.radius*Math.cos(M),k=v+a.radius*Math.sin(M);c=Math.min(c,Math.hypot(e-w,r-k))}s=[h+a.radius*Math.cos(p),v+a.radius*Math.sin(p)];break}case"arcTo":{const[h,v]=s,[u,p]=a.cp1,[g,d]=a.cp2,M=a.radius,w=h-u,k=v-p,S=g-u,I=d-p,W=Math.atan2(k,w),z=(Math.atan2(I,S)-W+Math.PI*3)%(Math.PI*2)-Math.PI,D=W+z/2,$=u+M*Math.cos(D+Math.PI/2),q=p+M*Math.sin(D+Math.PI/2),H=Math.atan2(v-q,h-$),it=Math.atan2(d-q,g-$);for(let U=0;U<=50;U++){const N=U/50,nt=H+(it-H)*N,rt=$+M*Math.cos(nt),at=q+M*Math.sin(nt);c=Math.min(c,Math.hypot(e-rt,r-at))}s=[g,d];break}case"ellipse":{const[h,v]=a.center,u=a.radiusX,p=a.radiusY,g=a.rotation??0;for(let d=0;d<=50;d++){const M=d/50*2*Math.PI,w=Math.cos(M),k=Math.sin(M),S=h+u*w*Math.cos(g)-p*k*Math.sin(g),I=v+u*w*Math.sin(g)+p*k*Math.cos(g);c=Math.min(c,Math.hypot(e-S,r-I))}s=[h+u*Math.cos(0),v+p*Math.sin(0)];break}}return c<=Math.max(5,o/2)}}class ee{match(t,e){return!0}strategies;none=()=>({minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0});constructor(){this.strategies=[],this.strategies.push(new Zt),this.strategies.push(new Jt),this.strategies.push(new Qt),this.strategies.push(new Kt),this.strategies.push(new te),this.strategies.push(new Et)}compute(t,e){for(const r of this.strategies)if(r.match(t,e))return r.computeAABB(t,e);return{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}exec(t,e,r,n,o){let s=t.ecs.getComponent(e,y.BoundingBoxComponent);if(s||(s=new y.BoundingBoxComponent,t.ecs.addComponent(e,s)),!s.dirty)return;const c=this.compute(t.ecs,e);if(s.setSelf(c),s.setChildren(n.childrenAABB||this.none()),s.updateTotalAABB(),r!==null&&o!==null){let a=t.ecs.getComponent(r,y.BoundingBoxComponent);a||(a=new y.BoundingBoxComponent,t.ecs.addComponent(r,a)),o.childrenAABB||(o.childrenAABB=this.none()),this.merge(o.childrenAABB,s.totalAABB),a.dirty=!0}}merge(t,e){t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY)}}class nn{match(t,e){return t.hasComponent(e,y.Path)}exec(t,e){const r=t.ecs,n=r.canvas.getContext("2d"),o=r.getComponent(e,y.Transform),s=r.getComponent(e,y.Path);if(!s.render||!s.commands.length)return;n.save(),n.globalAlpha=s.alpha;const c=o.worldMatrix;n.setTransform(c[0],c[1],c[3],c[4],c[6],c[7]),n.beginPath();for(const a of s.commands)switch(a.type){case"moveTo":n.moveTo(a.x,a.y);break;case"lineTo":n.lineTo(a.x,a.y);break;case"quadraticCurveTo":n.quadraticCurveTo(a.cp[0],a.cp[1],a.end[0],a.end[1]);break;case"bezierCurveTo":n.bezierCurveTo(a.cp1[0],a.cp1[1],a.cp2[0],a.cp2[1],a.end[0],a.end[1]);break;case"arc":n.arc(a.center[0],a.center[1],a.radius,a.start,a.end,!!a.counterClockwise);break;case"arcTo":n.arcTo(a.cp1[0],a.cp1[1],a.cp2[0],a.cp2[1],a.radius);break;case"ellipse":n.ellipse(a.center[0],a.center[1],a.radiusX,a.radiusY,a.rotation??0,a.start??0,a.end??2*Math.PI,!!a.counterClockwise);break;case"close":n.closePath();break}s.fillStyle&&(n.fillStyle=s.fillStyle,n.fill()),s.strokeStyle&&s.lineWidth>0&&(n.strokeStyle=s.strokeStyle,n.lineWidth=s.lineWidth,n.stroke()),n.restore()}}class rn{match(t,e){return t.hasComponent(e,y.Polyline)}exec(t,e){const r=t.ecs,n=r.canvas.getContext("2d"),o=r.getComponent(e,y.Transform),s=r.getComponent(e,y.Polyline);if(!s.render||s.points.length<2)return;n.save(),n.globalAlpha=s.alpha;const c=o.worldMatrix;n.setTransform(c[0],c[1],c[3],c[4],c[6],c[7]),n.beginPath();const a=s.points;n.moveTo(a[0][0],a[0][1]);for(let h=1;h<a.length;h++)n.lineTo(a[h][0],a[h][1]);s.closed&&n.closePath(),s.closed&&s.fillStyle&&(n.fillStyle=s.fillStyle,n.fill()),s.strokeStyle&&s.lineWidth>0&&(n.strokeStyle=s.strokeStyle,n.lineWidth=s.lineWidth,n.stroke()),n.restore()}}class sn{match(t,e){return t.hasComponent(e,y.Curve)}exec(t,e){const r=t.ecs,n=r.canvas.getContext("2d"),o=r.getComponent(e,y.Transform),s=r.getComponent(e,y.Curve);if(!s.render)return;n.save(),n.globalAlpha=s.alpha;const c=o.worldMatrix;n.setTransform(c[0],c[1],c[3],c[4],c[6],c[7]),n.beginPath(),n.moveTo(s.start[0],s.start[1]),s.cp2?n.bezierCurveTo(s.cp1[0],s.cp1[1],s.cp2[0],s.cp2[1],s.end[0],s.end[1]):n.quadraticCurveTo(s.cp1[0],s.cp1[1],s.end[0],s.end[1]),s.strokeStyle&&s.lineWidth>0&&(n.strokeStyle=s.strokeStyle,n.lineWidth=s.lineWidth,n.stroke()),n.restore()}}class an extends At{constructor(t,e){super(t,e),this.engine=t,this.sceneTree=e}ctx;processes=[];onInit(){const t=this.ecs.canvas;if(!t)throw new Error("Canvas not set on ECS");const e=t.getContext("2d");if(!e)throw new Error("Cannot get CanvasRenderingContext2D");this.ctx=e,this.processes.push(new Vt,new De,new Fe,new Le,new rn,new sn,new nn),this.bboxProcess=new ee}bboxProcess;update(){console.log(""),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);const t=new Map;t.set(null,{dirty:!1});const e=this.sceneTree.displayList;for(let r=0;r<e.length;r++){const[n,o]=e[r];t.has(n)||t.set(n,{});const s=t.get(n),c=t.get(o);for(const a of this.processes)a.match(this.ecs,n)&&a.exec(this,n,o,s,c)}for(let r=e.length-1;r>=0;r--){const[n,o]=e[r],s=t.get(n),c=t.get(o);this.bboxProcess.exec(this,n,o,s,c)}}}class on{match(t,e){return!0}strategies;constructor(){this.strategies=[],this.strategies.push(new Zt),this.strategies.push(new Jt),this.strategies.push(new Qt),this.strategies.push(new Kt),this.strategies.push(new te),this.strategies.push(new Et)}hit(t,e,r,n){for(const o of this.strategies)if(o.match(t,e))return o.hit(t,e,r,n);return!1}exec(t,e,r,n,o){}}class ne extends At{ctx;eventEntities=[];bboxProcess;transformProcess;RenderableHitProcess;onInit(){this.transformProcess=new Vt,this.bboxProcess=new ee,this.RenderableHitProcess=new on}hitAABB(t,e,r){return t>=r.minX&&e>=r.minY&&t<=r.maxX&&e<=r.maxY}hitRenderable(t,e,r){return this.RenderableHitProcess.hit(this.ecs,r,t,e)}hitTree(t,e){const r=this.sceneTree,n=s=>{if(s===null)return null;const c=this.ecs.getComponent(s.entityId,y.BoundingBoxComponent);if(!this.hitAABB(t,e,c.totalAABB))return null;for(let a=s.children.length-1;a>=0;a--){const h=n(s.children[a]);if(h)return h}return this.hitAABB(t,e,c.selfAABB)&&this.hitRenderable(t,e,s.entityId)?s:null},o=n(r.root);return o!==null?o.entityId:null}pickEntityAt(t,e){return this.updateTree(),this.hitTree(t,e)}updateTree(){const t=new Map;t.set(null,{dirty:!1});const e=this.sceneTree.displayList;for(let r=0;r<e.length;r++){const[n,o]=e[r];t.has(n)||t.set(n,{});const s=t.get(n),c=t.get(o);this.transformProcess.exec(this,n,o,s,c)}for(let r=e.length-1;r>=0;r--){const[n,o]=e[r],s=t.get(n),c=t.get(o);this.bboxProcess.exec(this,n,o,s,c)}}update(){}}class cn{listeners={};on(t,e){(this.listeners[t]??=new Set).add(e)}off(t,e){e?this.listeners[t]?.delete(e):delete this.listeners[t]}emit(t,...e){const r=this.listeners[t];if(r)for(const n of r)n(...e)}clear(t){t?delete this.listeners[t]:this.listeners={}}}class hn extends At{constructor(t,e){super(t,e),this.engine=t,this.sceneTree=e}ctx;processes=[];onInit(){const t=this.ecs.canvas;if(!t)throw new Error("Canvas not set on ECS");const e=t.getContext("2d");if(!e)throw new Error("Cannot get CanvasRenderingContext2D");this.ctx=e}update(){if(!this.engine.boxDebug)return;const t=new Map;t.set(null,{dirty:!1});const e=this.sceneTree.displayList;for(let r=e.length-1;r>=0;r--){const[n,o]=e[r];t.has(n)||t.set(n,{}),this.drawTotal(n),this.drawSelf(n)}}drawSelf(t){const e=this.ecs.getComponent(t,y.BoundingBoxComponent);e&&this.draw(e.totalAABB,"#ff0000",1)}drawTotal(t){const e=this.ecs.getComponent(t,y.BoundingBoxComponent);e&&this.draw(e.selfAABB,"blue",3)}drawChildren(t){const e=this.ecs.getComponent(t,y.BoundingBoxComponent);e&&this.draw(e.childrenAABB,"green",2)}draw(t,e="#ff0000",r=1){const n=this.ctx;n.save(),n.beginPath(),n.moveTo(t.minX,t.minY),n.lineTo(t.maxX,t.minY),n.lineTo(t.maxX,t.maxY),n.lineTo(t.minX,t.maxY),n.closePath(),n.strokeStyle=e,n.lineWidth=r,n.stroke(),n.restore()}}var ln=Object.getOwnPropertyDescriptor,fn=(i,t,e,r)=>{for(var n=r>1?void 0:r?ln(t,e):t,o=i.length-1,s;o>=0;o--)(s=i[o])&&(n=s(n)||n);return n};y.EventComponent=class{events=new Map;on(t,e){this.events.has(t)||this.events.set(t,[]),this.events.get(t).push(e)}off(t,e){if(!e)this.events.delete(t);else{const r=this.events.get(t);if(!r)return;this.events.set(t,r.filter(n=>n!==e))}}emit(t,e,r){const n=this.events.get(t);if(!n)return!1;let o=!1;for(const s of n)s(e,r)===!0&&(o=!0);return o}},y.EventComponent=fn([et("Event")],y.EventComponent);class un extends At{onInit(){this.initPointerEvents()}initPointerEvents(){const t=this.ecs.canvas;if(!t)throw new Error("ECS.canvas ");const e=["click"];for(const r of e)t.addEventListener(r,n=>this.handleEvent(n,r))}handleEvent(t,e){const n=this.ecs.canvas.getBoundingClientRect();let o=0,s=0;if("clientX"in t&&"clientY"in t)o=t.clientX-n.left,s=t.clientY-n.top;else if("touches"in t&&t.touches.length>0){const a=t.touches[0];o=a.clientX-n.left,s=a.clientY-n.top}const c=this.ecs.getSystem(ne).pickEntityAt(o,s);c!=null&&this.propagateEvent(c,e,t)}propagateEvent(t,e,r){let n=this.sceneTree.get(t);for(;n;){const o=this.ecs.getComponent(n.entityId,y.EventComponent);if(o&&o.emit(e,r,n.entityId))break;n=n.parent}}update(){}}class dn{boxDebug=!1;ecs;ticker;sceneTree;rootEntity;event;constructor(t){this.event=new cn,this.ecs=new xe,this.ecs.canvas=t,this.rootEntity=new Xe(this),this.sceneTree=new Te(this.rootEntity.entityId),this.ecs.addSystem(new an(this,this.sceneTree)),this.ecs.addSystem(new hn(this,this.sceneTree)),this.ecs.addSystem(new ne(this,this.sceneTree)),this.ecs.addSystem(new un(this,this.sceneTree)),this.ticker=new _e,this.ticker.add(e=>this.ecs.update(e))}start(){this.ticker.start(),this.event.emit("start")}stop(){this.ticker.stop(),this.event.emit("stop")}add(t,e){if(!this.ecs.hasEntity(t))throw new Error(`Entity ${t} not exists`);if(e&&!this.ecs.hasEntity(e))throw new Error(`Parent entity ${e} not found`);if(e&&!this.sceneTree.has(e))throw new Error(`Entity ${e} not exists`);this.sceneTree.add(t,e),this.event.emit("add",t)}setParent(t,e){if(!this.ecs.hasEntity(e))throw new Error(`Entity ${e} not exists`);if(t&&!this.ecs.hasEntity(t))throw new Error(`Parent entity ${t} not found`);if(!this.sceneTree.has(t))throw new Error(`Entity ${t} not exists`);const r=this.sceneTree.get(t),n=this.sceneTree.get(e);r.addChild(n),this.event.emit("setParent",t,e)}remove(t){this.sceneTree.destory(t),this.ecs.removeEntity(t),this.event.emit("remove",t)}getParent(t){return this.sceneTree.getParent(t)}getNode(t){return this.sceneTree.get(t)}clear(){this.sceneTree.clear(),this.event.emit("clear")}}const pn=Object.freeze(Object.defineProperty({__proto__:null,get BoundingBoxComponent(){return y.BoundingBoxComponent},get Circle(){return y.Circle},get Curve(){return y.Curve},get EventComponent(){return y.EventComponent},get Image(){return y.Image},get Path(){return y.Path},get Polyline(){return y.Polyline},get Rect(){return y.Rect},get Transform(){return y.Transform}},Symbol.toStringTag,{value:"Module"}));async function mn(i,t,e){try{const r=await fetch(i,{mode:"cors"});if(!r.ok)throw new Error(`Failed to load image: ${i}, status ${r.status}`);const n=await r.blob();if(t){const[o,s,c,a]=t;return await createImageBitmap(n,o,s,c,a,e)}else return await createImageBitmap(n,e)}catch(r){throw console.error("loadImageBitmap error:",r),r}}y.Components=pn,y.Engine=dn,y.loadImageBitmap=mn,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=web-ecs.umd.js.map
